<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    iframe { border: 1px; height: 50px; width: 100%; }
  </style>
</head>
<body>

<p>
  Used <span class="mb"></span> MB of disk space!
</p>

<button class="free">Stop</button>

<iframe src="http://1.filldisk.com/frame.html?free=0&amp;highest=0"></iframe>

<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> -->

<script>
var mb = document.querySelector('.mb')
var free = document.querySelector('.free')
var frame = document.querySelector('iframe')

if (!localStorage['highest']) {
  localStorage['highest'] = 1
}

window.addEventListener('message', onMessage, false)
free.addEventListener('click', freeSpace, false)

function onMessage (event) {

  var frameNum = event.data

  /**
   * Save the highest subdomain that we've set data on,
   * so that we can reclaim the space later.
   */

  try {
    localStorage['highest'] = frameNum
  } catch (e) {
    console.error('local storage exception')
    return
  }

  /**
   * Calculate the amount of used space in MB
   */

  var usedMB = parseInt(localStorage['highest']) * 5
  mb.innerHTML = usedMB

  /**
   * Set background of page to match amount of used space.
   */

   var nonRed = (255 - Math.min(parseInt(event.data), 255)).toString(16)
   document.body.style.background = '#FF' + nonRed + nonRed

}

/**
 * Injects a CSS style tag into page.
 * @param  {String} rules CSS rules to inject
 */

function injectFrame (src) {
  var frame = document.createElement('iframe')
  frame.src = src
  document.getElementsByTagName('body')[0].appendChild(frame)
}

function freeSpace (event) {
  alert('free')
  frame.src = 'http://' + localStorage.highest + '.filldisk.com/frame.html?free=true&highest=' + localStorage.highest

}

</script>
</body>
</html>